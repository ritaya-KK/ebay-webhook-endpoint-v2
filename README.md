# eBay販売管理・古物台帳システム

## 概要

このシステムは、eBayでの販売管理、利益計算、古物台帳の管理を自動化するGoogle Apps Script（GAS）ベースのツールです。

## 主な機能

### 1. 在庫管理シート（古物台帳）
- 商品の仕入れ情報を記録
- 古物営業法に準拠した台帳管理
- 仕入れ先による還付率の自動判定（個人8%、商店10%）
- リサーチ商品の管理

### 2. 販売管理シート（利益計算）
- eBay APIからの注文データ自動取得
- 返金データの自動取得
- 利益計算の自動化
- 還付制度を考慮した最終利益計算

### 3. 固定費管理シート
- eBayストア料金などの固定費管理
- 月次での費用集計

### 4. 外注費管理シート
- クラウドワークスや個人への外注費管理
- リサーチ商品の利益配分（5%）の自動計算

### 5. 送料管理シート
- 注文IDごとの送料データ管理
- CSVファイルからの自動インポート

### 6. 設定シート
- eBay API設定
- 為替レート、還付率などの基本設定
- **（自動生成）Webhook用Verification Token**

## セットアップ手順

### Step 1: スプレッドシートの作成とスクリプトのコピー
1. Google Driveで新しいスプレッドシートを作成します。
2. 「拡張機能」 > 「Apps Script」を開き、提供された5つの `.gs` ファイル (`create_spreadsheet.gs`, `ebay_api_integration.gs`, `csv_import_automation.gs`, `webhook_handler.gs`, `menu_integration.gs`) の内容をそれぞれコピー＆ペーストして保存します。

### Step 2: スプレッドシートの初期化
1. Apps Scriptエディタで、関数リストから `createEbayManagementSpreadsheet` を選択し、初回実行（▶ボタン）します。
2. 承認を求められたら、許可してください。
3. これで必要なシートが全て自動生成されます。

### Step 3: eBay APIとWebhookの設定
詳細は `SETUP_GUIDE.md` を参照してください。

## Webhook (Marketplace Account Deletion通知) 設定

本システムは、サーバー不要でeBayからの通知（アカウント削除通知など）を受け取るために、Google Apps ScriptのWebアプリ機能を利用します。

### 設定方法
1. **Verification Tokenの確認**:
   - 自動生成された「設定シート」の `eBay Verification Token` の値を確認します。初期値は以下の通りです。
   - `MyUniqueTokenForEbayWebhookByRyuji321GoGo`

2. **Webアプリのデプロイ**:
   - Apps Scriptエディタ右上の「デプロイ」>「新しいデプロイ」を選択します。
   - 種類を「ウェブアプリ」に設定し、アクセスできるユーザーを「**全員**」にしてデプロイします。
   - 表示される「ウェブアプリのURL」をコピーします。

3. **eBay Developer Portalでの設定**:
   - 「Marketplace account deletion notification endpoint」に、上記でコピーした**ウェブアプリのURL**を貼り付けます。
   - 「Verification token」に、**設定シートにあるトークンの値** (`MyUniqueTokenForEbayWebhookByRyuji321GoGo`) を貼り付けます。
   - 「Save」をクリックして保存します。

### セキュリティに関する注記
Google Apps Scriptの制約上、eBayから送られてくるリクエストの電子署名（ECDSA）を検証することが困難です。そのため、本システムでは署名の検証をスキップし、来た通知を全てログに記録する仕様となっています。この点をご理解の上、ご使用ください。

## 使用方法

### 基本操作

#### 1. 新商品の追加
1. 「在庫管理」メニュー→「新商品追加」を選択
2. 商品情報を入力
3. リサーチ商品かどうかを選択
4. 自動で商品ID、仕入れ先区分、還付率が設定される

#### 2. 一括商品追加
1. 「在庫管理」メニュー→「一括商品追加」を選択
2. CSV形式で商品情報を入力
3. 複数の商品を一度に追加

#### 3. eBayデータの取得
1. 「eBay管理」メニュー→「eBay注文データ取得」を選択
2. 最新の注文データが自動で取得される
3. 利益計算が自動で実行される

#### 4. 送料データのインポート
1. 「在庫管理」メニュー→「送料CSVインポート」を選択
2. CSVファイルの内容を貼り付け
3. 送料データが自動でインポートされる

### 利益計算の仕組み

#### 1. 一時販売利益
```
一時販売利益 = 販売価格 - 仕入れ価格 - eBay手数料 - PayPal手数料 - 送料 - その他経費
```

#### 2. 還付金額
```
還付金額 = 仕入れ価格 × 還付率（個人8% / 商店10%）
```

#### 3. 還付後最終利益
```
還付後最終利益 = 一時販売利益 + 還付金額 - 返金金額
```

#### 4. 月次純利益
```
月次純利益 = 還付後最終利益の合計 - 固定費 - 外注費
```

### リサーチ商品の利益配分

リサーチ商品の還付後最終利益の5%が外注スタッフに配分されます。

## データ検証機能

### 1. データ検証
- 「在庫管理」メニュー→「データ検証」を選択
- 必須項目の入力漏れや整合性をチェック

### 2. 仕入れ先区分・還付率の自動更新
- 「在庫管理」メニュー→「仕入れ先区分・還付率自動更新」を選択
- 仕入れ先に基づいて自動で区分と還付率を更新

## 月次レポート

### 1. レポート生成
- 「eBay管理」メニュー→「月次レポート生成」を選択
- 当月の売上、利益、費用の集計レポートを生成

### 2. レポート内容
- 総販売額
- 一時販売利益
- 返金金額
- 還付後最終利益
- 固定費合計
- eBayストア料金
- 純利益
- リサーチ商品利益
- リサーチ利益配分（5%）

## 注意事項

### 1. eBay API制限
- API呼び出し回数に制限があります
- 大量のデータ取得時は時間を分けて実行してください

### 2. データバックアップ
- 重要なデータは定期的にバックアップを取ってください
- Google Driveのバージョン履歴を活用してください

### 3. 為替レート
- 設定シートで為替レートを定期的に更新してください
- 正確な利益計算のため重要です

### 4. 古物台帳の法的要件
- 古物営業法に基づく記録義務を満たすため、仕入れ先の情報は正確に入力してください
- 必要に応じて税理士に相談してください

## トラブルシューティング

### 1. eBay API認証エラー
- API KeyとSecretが正しく設定されているか確認
- eBay Developer Programの設定を確認

### 2. データが取得できない
- インターネット接続を確認
- eBay APIの利用制限を確認
- 設定シートの日付範囲を確認

### 3. 計算が正しくない
- 設定シートの為替レートを確認
- 仕入れ先区分と還付率の設定を確認
- データ検証機能を実行

## サポート

システムに関する質問や問題がございましたら、開発者までお問い合わせください。

## 更新履歴

- v1.0.0: 初回リリース
  - 基本的な販売管理機能
  - eBay API連携
  - 古物台帳機能
  - 利益計算機能 